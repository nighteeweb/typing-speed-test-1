let text_easy = {
    1 : "The sun rose over the quiet town. Birds sang in the trees as people woke up and started their day. It was going to be a warm and sunny morning.",
    2 : "She walked to the store to buy some bread and milk. The shop was busy but she found what she needed quickly. On her way home, she saw a friend and waved.",
    3 : "The dog ran across the park chasing a ball. He was fast and loved to play. After a while, he got tired and lay down in the cool shade of a big oak tree.",
    4 : "I like to read books before I go to sleep. It helps me relax after a long day. My favorite stories are about adventure and travel to far away places.",
    5 : "The kitchen smelled of fresh coffee and toast. Mom was making breakfast while dad read the news. It was a normal morning in their small but cozy home.",
    6 : "We went to the beach last summer. The water was blue and the sand was warm. We built a big sand castle and looked for shells along the shore.",
    7 : "The cat sat on the window sill watching the rain. Drops fell down the glass one by one. She seemed happy to be inside where it was dry and warm.",
    8 : "My best friend lives next door to me. We play games together after school. Sometimes we ride our bikes around the block or sit and talk for hours.",
    9 : "Spring is my favorite time of year. Flowers start to bloom and the days get longer. I love to see the trees turn green again after the cold winter months.",
    10: "The music played softly in the room. She closed her eyes and let the sounds wash over her. It was a simple song but it made her feel at peace." 
}
let text_medium = {
    1 : "Learning a new skill takes patience and consistent practice. Whether you're studying a language, picking up an instrument, or mastering a sport, the key is to show up every day. Small improvements compound over time, and before you know it, you'll have made remarkable progress.",
    2 : "The old lighthouse had stood on the cliff for over a century, guiding sailors safely through treacherous waters. Its beam cut through the fog each night, a reassuring presence for those navigating the rocky coastline. Many storms had tested its structure, but it remained steadfast.",
    3 : "Coffee culture has evolved dramatically in recent decades. What was once a simple morning ritual has become an art form, with baristas crafting intricate latte designs and roasters sourcing beans from remote mountain villages. The humble cup of coffee now tells a global story.",
    4 : "Urban gardens are transforming city landscapes around the world. Residents are converting rooftops, balconies, and abandoned lots into thriving green spaces. These initiatives not only provide fresh produce but also create communities, reduce stress, and help combat the urban heat island effect.",
    5 : "The documentary explored how technology shapes our daily habits. From the moment we wake to an alarm on our phones to the podcasts we fall asleep to, digital tools have woven themselves into the fabric of modern life. The question is: are we in control?",
    6 : "Traveling by train offers a unique perspective on the countryside. Unlike flying, which reduces landscapes to abstract patterns, rail journeys let you witness the gradual transitions between regions. You see farms give way to forests, and small towns emerge from rolling hills.",
    7 : "The chef believed that great cooking starts with quality ingredients. She visited local farmers each week, selecting vegetables at their peak ripeness. Her menu changed with the seasons, reflecting what the land offered. Diners appreciated the freshness they could taste in every bite.",
    8 : "Libraries have reinvented themselves for the digital age. Beyond lending books, they now offer coworking spaces, 3D printers, recording studios, and coding workshops. These community hubs have become places where people of all ages come to learn, create, and connect with others.",
    9 : "The architect designed buildings that worked with nature rather than against it. Large windows captured natural light, reducing the need for electricity. Green roofs absorbed rainwater and provided insulation. Her philosophy was simple: sustainable design should be beautiful, functional, and accessible to everyone.",
    10: "Night markets come alive after sunset in cities across Asia. Vendors set up stalls selling everything from grilled skewers to handmade crafts. The air fills with enticing aromas and the buzz of conversation. Locals and tourists alike wander through, sampling street food and hunting for bargains.",
}
let text_hard = {
    1 : "The philosopher's argument hinged on a seemingly paradoxical assertion: that absolute freedom, pursued without constraint, inevitably undermines itself. \"Consider,\" she wrote, \"how the libertarian ideal—when taken to its logical extreme—produces conditions in which the powerful dominate the weak, thereby eliminating freedom for the majority.\" Her critics dismissed this as sophistry; her supporters hailed it as profound.",
    2 : "Quantum entanglement—Einstein's \"spooky action at a distance\"—continues to perplex physicists and philosophers alike. When two particles become entangled, measuring one instantaneously affects the other, regardless of the distance separating them. This phenomenon doesn't violate relativity (no information travels faster than light), yet it challenges our intuitions about locality, causality, and the nature of reality itself.",
    3 : "The Renaissance polymath's correspondence reveals a mind of extraordinary breadth: in a single week's letters, he discussed astronomical observations, critiqued a colleague's architectural drawings, proposed improvements to the city's sewage system, and composed a sonnet for a patron's daughter. \"Specialization,\" he remarked wryly, \"is for insects.\" His contemporaries found him exhausting; posterity finds him inspirational.",
    4 : "Algorithmic trading has fundamentally restructured financial markets. High-frequency systems execute thousands of transactions per second, exploiting minute price discrepancies across exchanges. Critics argue this creates systemic fragility—the 2010 \"Flash Crash\" saw the Dow Jones plummet 1,000 points in minutes before recovering. Proponents counter that algorithms provide liquidity and reduce spreads, ultimately benefiting retail investors.",
    5 : "The biographer faced an ethical dilemma: her subject's private journals—recently discovered in an attic—contained revelations that would overturn his carefully cultivated public image. Should she publish them? \"Biography,\" she mused, \"exists in tension between truth-telling and respect for the dead.\" After months of deliberation, she chose disclosure, reasoning that sanitized history serves no one.",
    6 : "Microplastics have infiltrated virtually every ecosystem on Earth, from the Mariana Trench to Arctic ice cores. These polymer fragments—smaller than 5mm in diameter—originate from degrading consumer products, synthetic textiles, and industrial processes. Researchers have detected them in human blood, placental tissue, and breast milk; their long-term health implications remain disturbingly unclear. The ubiquity of plastic pollution represents an unprecedented experiment on planetary biology.",
    7 : "The conductor's interpretation of Mahler's Ninth Symphony emphasized its prophetic qualities—the premonition of catastrophe, the aching nostalgia for a world about to vanish. \"Mahler composed this knowing he was dying,\" she explained in the program notes, \"but he also intuited, somehow, that European civilization itself stood at the precipice.\" The orchestra's performance—hushed, trembling, transcendent—left the audience in stunned silence.",
    8 : "Constitutional scholars continue debating the \"counter-majoritarian difficulty\": how can judicial review—whereby unelected judges overturn legislation passed by democratic representatives—be reconciled with popular sovereignty? Some argue courts protect minority rights against tyrannical majorities; others contend this reasoning masks ideological preferences in neutral-sounding jurisprudence. The tension, perhaps, is irresolvable; democratic systems must balance competing values rather than optimize for any single principle.",
    9 : "The novelist's prose style—elliptical, fragmented, punctuated by abrupt temporal shifts—reflected her thematic preoccupations: memory's unreliability, identity's fluidity, the impossibility of objective narration. \"Every story,\" she declared in an interview, \"is simultaneously true and false; it reveals by concealing, illuminates by casting shadows.\" Critics accused her of obscurantism; she responded that clarity itself can be a form of deception.",
    10: "The archaeological expedition unearthed artifacts that complicated prevailing theories about Bronze Age trade networks. Obsidian from Anatolia, lapis lazuli from Afghanistan, and amber from the Baltic—all discovered in a single Mycenaean tomb—suggested commercial connections far more extensive than previously hypothesized. \"We've underestimated ancient peoples' navigational capabilities and their appetite for luxury goods,\" the lead researcher observed. \"Globalization isn't as modern as we assume.\"",
}
const pb_wpm = document.querySelector("#personal-best-score");
const start_div = document.querySelector(".start-button");
const button_start = document.querySelector("#start");
const text = document.querySelector("#text");
const input = document.querySelector("#hidden-input");
const wpm = document.querySelector("#wpm")
const accuracy = document.querySelector("#accuracy")
const time = document.querySelector("#time");
const easy_button = document.querySelector("#easy");
const medium_button = document.querySelector("#medium");
const hard_button = document.querySelector("#hard");
const timed_button = document.querySelector("#mode-timed");
const passage_button = document.querySelector("#mode-passage");
const main_game_window = document.querySelector(".main");
const main_result_window = document.querySelector(".test-complete");
const result_wpm = document.querySelector("#result-wpm");
const result_accuracy = document.querySelector("#result-accuracy");
const result_characters_correct = document.querySelector("#result-correct");
const result_characters_wrong = document.querySelector("#result-wrong");
const restart_button = document.querySelector("#again");
const restart_button_test = document.querySelector("#restart-button");
const icon1 = document.querySelector("#icon-completed");
const icon1_container = document.querySelector(".icon-completed-container");
const test_complete_head = document.querySelector("#test-complete-head");
const test_complete_desc = document.querySelector("#test-complete-description");
const icon_star1 = document.querySelector("#icon-star-1");
const icon_star2 = document.querySelector("#icon-star-2");
const confetti = document.querySelector("#confetti");
const line = document.querySelector("#line");
const selectHeaders = document.querySelectorAll('.select-header');
let is_started = false;
let charSpans;
let charIndex;
let currentText;
let num_of_letters;
let best_wpm = 0;

// таймер (header)
let timer1;
let time_now = 60;
let result_time = 0;
let timer = function() {
    time_now--;

    // time
    if (time_now < 20) {
        time.style.color = "#f4dc71";
    }
    if(time_now < 10) {
        time.style.color = "#d64c5a";
        time.textContent = "0:0"+time_now;
    }
    else {
        time.textContent = "0:"+time_now;
    }
    if (time_now == 0){
        result_time = 60;
        is_started = false;
        clearInterval(timer1);
        clearInterval(stats_now_time);
        open_results();
    }
}

// вычисление статистики в настоящем времени
let num_of_letters_now = 0;
let correct_letters = 1;
let wrong_letters = 0;
let stats_now_timer = function() {
    wpm.textContent = Math.floor(num_of_letters_now * 12);
    num_of_letters_now = 0;
    accuracy.textContent = 100 - Math.floor(wrong_letters/all_letters * 100) + "%";
    if(100 - Math.floor(wrong_letters/all_letters * 100) < 95){
        accuracy.style.color = "#d64c5a";
    } else {
        accuracy.style.color = "";
    }
}
let stats_now_time;

// клик на кнопку старт
start_div.onclick = function() {
    num_of_letters = 0;
    correct_letters = 0;
    wrong_letters = 0;
    is_started = true;
    text.style.filter = "none";
    start_div.style.visibility = "hidden";
    restart_button_test.style.visibility = "visible";
    line.style.visibility = "visible";
    timer1 = setInterval(timer, 1000);
    stats_now_time = setInterval(stats_now_timer, 1000);

    // заполнение в span
    currentText = text.textContent;
    text.innerHTML = '';
    charSpans = [...currentText].map(char => {
        const span = document.createElement('span');
        span.textContent = char;
        span.className = 'char';
        text.appendChild(span);
        return span;
    })
    charIndex = 0;
    input.disabled = false;
    input.focus();
    charSpans[charIndex].classList.add("current");

    all_letters = text.textContent.length;
}

// настройка сложности
let difficulty = 3;
let random;
easy_button.onclick = function() {
    if (difficulty != 1 && !is_started){
        difficulty = 1;
        random = Math.floor(Math.random() * 10 + 1);
        text.textContent = text_easy[random];
        this.style.color = "#4da6ff";
        this.style.border = "1px solid var(--blue-400)";
        medium_button.style.color = "";
        medium_button.style.border = "";
        hard_button.style.color = "";
        hard_button.style.border = "";
    }
}
medium_button.onclick = function() {
    if (difficulty != 2 && !is_started){
        difficulty = 2;
        random = Math.floor(Math.random() * 10 + 1);
        text.textContent = text_medium[random];
        this.style.color = "#4da6ff";
        this.style.border = "1px solid var(--blue-400)";
        easy_button.style.color = "";
        easy_button.style.border = "";
        hard_button.style.color = "";
        hard_button.style.border = "";
    }
}
hard_button.onclick = function() {
    if (!is_started){
        difficulty = 3;
        if(difficulty != 3 ){
            random = Math.floor(Math.random() * 10 + 1);
            text.textContent = text_hard[random];
        } else { text.textContent = text_hard[10];}
        this.style.color = "#4da6ff";
        this.style.border = "1px solid var(--blue-400)";
        medium_button.style.color = "";
        medium_button.style.border = "";
        easy_button.style.color = "";
        easy_button.style.border = "";
    }
}

// настройка режима
timed_button.onclick = function() {
    if(!is_started){
        this.style.color = "#4da6ff";
        this.style.border = "1px solid var(--blue-400)";
        passage_button.style.color = "";
        passage_button.style.border = "";
    }
}
passage_button.onclick = function() {
    if(!is_started){
        this.style.color = "#4da6ff";
        this.style.border = "1px solid var(--blue-400)";
        timed_button.style.color = "";
        timed_button.style.border = "";
    }
}

// проверка текста
input.addEventListener('input', (e) => {
    if(!is_started) return;

    const typedChar = e.data;
    if(!typedChar || charIndex >= currentText.length){
        input.value = '';
        return;
    }

    num_of_letters++;
    num_of_letters_now++;

    const targetChar = currentText[charIndex];
    const currentSpan = charSpans[charIndex];
    currentSpan.classList.remove('current');

    if(typedChar === targetChar){
        currentSpan.classList.add('correct');
        correct_letters++;
    } else {
        currentSpan.classList.add('wrong');
        wrong_letters++;
    }

    charIndex++;

    if (charIndex < charSpans.length){
        charSpans[charIndex].classList.add('current');
    } else {
        is_started = false;
        input.disabled = true;
        result_time = 60 - time_now;
        clearInterval(timer1);
        clearInterval(stats_now_time);
        open_results();
    }

    input.value = '';
})

// возвращение фокуса при случайном клике
document.addEventListener('click', () => {
    if (is_started){
        input.focus();
    }
})

// окно результатов
function open_results() {
    alert(best_wpm);
    main_game_window.style.visibility = "hidden";
    main_result_window.style.visibility = "visible";
    restart_button_test.style.visibility = "hidden";
    line.style.visibility = "hidden";
    result_wpm.textContent = Math.floor(num_of_letters / 5 / result_time * 60);
    if (best_wpm == 0){
        best_wpm = result_wpm.textContent; 
        pb_wpm.textContent = best_wpm;
        test_complete_head.textContent = "Baseline Established!";
        test_complete_desc.textContent = "You've set the bar. Now the real challenge begins—time to beat it.";
        restart_button.innerHTML = 'Beat This Score <img id="icon-again" src="assets/images/icon-restart.svg" alt="icon-restart">';
        restart_button.style.width = "11em";
    }
    else if(result_wpm.textContent > best_wpm) { 
        best_wpm = result_wpm.textContent; 
        pb_wpm.textContent = best_wpm;
        icon1.src = "assets/images/icon-new-pb.svg";
        icon1_container.style.backgroundColor = "hsla(1, 1%, 1%, 0)";
        icon1_container.style.boxShadow = "none";
        test_complete_head.textContent = "High Score Smashed!";
        test_complete_desc.textContent = "You're getting faster. That was incredible typing.";
        restart_button.innerHTML = 'Beat This Score <img id="icon-again" src="assets/images/icon-restart.svg" alt="icon-restart">';
        restart_button.style.width = "11em";
        icon_star1.style.visibility = "hidden";
        icon_star2.style.visibility = "hidden";
        confetti.style.height = "25vw";
    } else {
        test_complete_head.textContent = "Test Complete!";
        test_complete_desc.textContent = "Solid run. Keep pushing to beat your high score.";
        restart_button.innerHTML = 'Go Again <img id="icon-again" src="assets/images/icon-restart.svg" alt="icon-restart">';
        restart_button.style.width = "8em";
    }
    result_accuracy.textContent = 100 - Math.floor(wrong_letters/all_letters * 100) + "%";
    if(100 - Math.floor(wrong_letters/all_letters * 100) < 95){ result_accuracy.style.color = "hsl(354, 63%, 57%)"; }
    else { result_accuracy.style.color = "hsl(140, 63%, 57%)"; }
    result_characters_correct.textContent = correct_letters;
    result_characters_wrong.textContent = wrong_letters;
}

// кнопка перезапуска
restart_button.onclick = function() {
    is_started = false;
    main_game_window.style.visibility = "visible";
    main_result_window.style.visibility = "hidden";
    restart_button_test.style.visibility = "hidden";
    line.style.visibility = "hidden";
    wpm.textContent = 0;
    accuracy.textContent = "100%";
    accuracy.style.color = "white";
    time.textContent = "0:60";
    time.style.color = "white";
    hard_button.onclick();
    timed_button.onclick();
    text.style.filter = "blur(7px)";
    start_div.style.visibility = "visible";
    confetti.style.height = 0;
}
restart_button_test.onclick = function() {
    is_started = false;
    main_game_window.style.visibility = "visible";
    main_result_window.style.visibility = "hidden";
    restart_button_test.style.visibility = "hidden";
    line.style.visibility = "hidden";
    wpm.textContent = 0;
    accuracy.textContent = "100%";
    accuracy.style.color = "white";
    time.textContent = "0:60";
    time.style.color = "white";
    clearInterval(timer1);
    clearInterval(stats_now_time);
    hard_button.onclick();
    timed_button.onclick();
    text.style.filter = "blur(7px)";
    start_div.style.visibility = "visible";
}

// выпадающее меню для телефонов
selectHeaders.forEach(header => {
    const arrow = header.querySelector('.arrow');
    header.addEventListener('click', () => {
        const optionsContainer = header.nextElementSibling;
        const isOpen = optionsContainer.style.maxHeight;

        if (isOpen) {
            optionsContainer.style.maxHeight = null;
            optionsContainer.style.opacity = 0;
            optionsContainer.style.pointerEvents = 'none';
            optionsContainer.style.transform = 'translateY(5px)';
            arrow.style.transform = "rotate(0deg)";
        } else {
            const height = optionsContainer.scrollHeight + 'px';
            optionsContainer.style.maxHeight = height;
            optionsContainer.style.opacity = 1;
            optionsContainer.style.pointerEvents = 'auto';
            optionsContainer.style.transform = 'translateY(0)';
            arrow.style.transform = "rotate(180deg)";
        }
    });
});

const menuActions = {
    'Easy': easy_button.onclick(),
    'Medium': medium_button.onclick(),
    'Hard': hard_button.onclick(),
    'Timed (60s)': timed_button.onclick(),
    'Passage': passage_button.onclick()
};

// Обработка выбора опции
const options = document.querySelectorAll('.option');
options.forEach(option => {
    option.addEventListener('click', () => {
        const value = option.textContent.trim();
        const selectHeader = option.closest('.custom-select').querySelector('.select-header');
        selectHeader.innerHTML = option.textContent + ' <img class="arrow" src="assets/images/icon-down-arrow.svg"/>';

        // Сброс активных состояний
        const activeOptions = option.closest('.options-container').querySelectorAll('.active');
        activeOptions.forEach(active => active.classList.remove('active'));
        option.classList.add('active');

        switch (value) {
            case 'Easy':
                easy_button.onclick();
                break;
            case 'Medium':
                medium_button.onclick();
                break;
            case 'Hard':
                hard_button.onclick();
                break;
            case 'Timed (60s)':
                timed_button.onclick();
                break;
            case 'Passage':
                passage_button.onclick();
                break;
            default:
                console.warn('Неизвестный пункт меню:', value);
    }

        const optionsContainer = option.closest('.options-container');
        optionsContainer.style.maxHeight = '0';
        optionsContainer.style.opacity = '0';
        optionsContainer.style.pointerEvents = 'none';
        optionsContainer.style.transform = 'translateY(5px)';
    });
});